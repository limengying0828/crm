<!DOCTYPE html>
<!--suppress ALL-->
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>新增售后服务</title>
    <link rel="stylesheet" href="../../../layui/css/layui.css">
    <script src="../../../js/jquery-3.4.1.js"></script>
    <script src="../../../layui/layui.js"></script>
</head>
<script type="text/javascript">
    goback=function () {
        window.close();
    }
    refresh=function () {
        window.location.href="";
    }
</script>
<body>
<form class="layui-form" action="" method="post">
    <center>
        <table width="80%">
            <tr>
                <td width="20%"><font size="5">新增售后服务</font></td>
                <td width="20%"></td>
                <td width="20%"></td>
                <td width="20%" align="right">
                    <button type="button" class="layui-btn layui-btn-primary" onclick="goback()"><i class="layui-icon layui-icon-return">返回</i></button>
                    <button type="button" class="layui-btn layui-btn-primary" onclick="refresh()"><i class="layui-icon layui-icon-refresh">刷新</i></button>
                </td>
            </tr>
            <tr>
                <td height="20px"></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr bgcolor="#fafad2">
                <td height="50px"><h2>新增售后服务</h2></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td height="5px"></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td><font color="red">*</font>主题</td>
                <td>
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <input type="text" name="theme" id="theme" required="" lay-verify="theme" placeholder="请输入主题" autocomplete="off" class="layui-input" >
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td></td>
                <td>
                    <div class="layui-form-item" style="margin-left: 40px;">
                        步  骤:<input type="text" style="border: 0px"  value="服务登记" name="step"><br/>
                        责任人:<input type="text" style="border: 0px"  id="username" name="username"><br/>
                        <input type="hidden" style="border: 0px"  id="userid" name="userid">
                        参与人:<input type="text" style="border: 0px"  value="" name="participant">
                    </div>
                </td>
            </tr>
            <tr bgcolor="#fafad2">
                <td height="50px"><h2>售后服务信息</h2></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td height="5px"></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td><font color="red">*</font>客户名称</td>
                <td>
                    <div class="layui-form-item">
                        <div class="layui-input-block" >
                            <select name="customerid" id="customerid"  lay-filter="customername" lay-verify="customername" onchange="customerChange()">
                                <option value="">请选择</option>
                            </select>
                        </div>
                    </div>
                </td>
                <td align="center"><font color="red">*</font>合同编号</td>
                <td align="right">
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <select id="contractid" name="contractid" lay-verify="contract" >
                                <option value="">请选择</option>
                            </select>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td>合同主要信息</td>
                <td colspan="3">
                    <div align="center" class="layui-form-item">
                        <div class="layui-input-block">
                            <textarea name="info" id="info" class="layui-input" required="" placeholder="请输入" autocomplete="off" lay-verify="">                            </textarea>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td><font color="red">*</font>对方联系人</td>
                <td>
                    <div class="layui-form-item" align="center">
                        <div class="layui-input-block">
                            <input type="text" name="contactperson" id="contactperson" required lay-verify="" placeholder="请输入"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </td>
                <td align="center">固定电话</td>
                <td align="right">
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <input type="text" name="officephone" id="officephone"  required lay-verify="" placeholder="请输入"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td>移动电话</td>
                <td>
                    <div class="layui-form-item" align="center">
                        <div class="layui-input-block">
                            <input type="text" name="telephone" id="telephone" required lay-verify="" placeholder="请输入"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </td>
                <td align="center">邮件/QQ</td>
                <td align="right">
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <input type="text" name="email" id="email" required lay-verify="" placeholder="请输入"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td>服务类型</td>
                <td>
                    <div class="layui-form-item">
                        <div class="layui-input-block" >
                            <select name="typeservices" lay-verify="typeservices">
                                <option value="">请选择</option>
                                <option value="故障申报">故障申报</option>
                                <option value="业务咨询">业务咨询</option>
                                <option value="实施或培训">实施或培训</option>
                                <option value="主动关怀">主动关怀</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                </td>
                <td align="center">服务方式</td>
                <td align="right">
                    <div class="layui-form-item">
                        <div class="layui-input-block" >
                            <select id="servicemode" name="servicemode" lay-verify="servicemode">
                                <option value="">请选择</option>
                                <option value="故障申报">故障申报</option>
                                <option value="业务咨询">业务咨询</option>
                                <option value="实施或培训">实施或培训</option>
                                <option value="主动关怀">主动关怀</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td><font color="red">*</font>开始时间</td>
                <td>
                    <div class="layui-form">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <input type="date" class="layui-input" id="begintime" name="begintime" lay-verify="begintime" placeholder="yyyy-MM-dd" lay-key="1">
                            </div>
                        </div>
                    </div>
                </div>
                </td>
                <td align="center">结束时间</td>
                <td align="right">
                    <div class="layui-form">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <div class="layui-input-inline">
                                    <input type="date" class="layui-input" id="overtime" name="overtime" placeholder="yyyy-MM-dd" lay-key="1" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td><font color="red">*</font>服务内容</td>
                <td colspan="3">
                    <div align="center" class="layui-form-item">
                        <div class="layui-input-block">
                            <textarea name="servicescontent" class="layui-input" required="" placeholder="请输入" autocomplete="off" lay-verify="servicescontent">                            </textarea>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td>客户反馈</td>
                <td colspan="3">
                    <div align="center" class="layui-form-item">
                        <div class="layui-input-block">
                            <textarea name="customerfeedback" class="layui-input" required="" placeholder="请输入" autocomplete="off" lay-verify="">                            </textarea>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td><font color="red">*</font>服务人员</td>
                <td>
                    <div class="layui-form-item" align="center">
                        <div class="layui-input-block">
                            <input type="text" name="servicespeople"  required lay-verify="servicespeople" placeholder="请输入"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>
                </td>
                <td align="center">服务评分</td>
                <td align="right">
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <input type="radio" value="5" name="servicesscore" title="5分">
                            <input type="radio" value="4" name="servicesscore" title="4分">
                            <input type="radio" value="3" name="servicesscore" title="3分">
                            <input type="radio" value="2" name="servicesscore" title="2分">
                            <input type="radio" value="1" name="servicesscore" title="1分">
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td>附件</td>
                <td>
                    <div class="layui-upload">
                        <button type="button" class="layui-btn" id="card"><i class="layui-icon layui-icon-upload-drag"></i>上传图片</i></button>
                        <div class="layui-upload-list">
                            <label class="layui-form-label">预览附件</label>
                            <img class="layui-upload-img" id="idcard" style="width: 100px;height: 100px;">
                        </div>
                    </div>
                    <input type="hidden" name="attachment" id="attachment" lay-verify="photo">
                </td>
            </tr>
            <tr>
                <td height="20px"></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr bgcolor="#fafad2">
                <td height="50px"><h2>处理流程日志</h2></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table><br><br>
        <div class="site-text">
            <div style="width:1250px;">
                <div style="float: left">
                        <div class="layui-input-block" style="border:1px solid ;color: #e2e2e2;height:480px;width:400px;">
                            <div>
                                <font size="3" color="black">【处理流程】</font><br/>
                                ----------------------------------------------------------------------
                            </div>
                            <a href="#"><font style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;哈哈哈哈哈</font></a>
                        </div>
                </div>
                <div style="float: left">
                        <div class="layui-form-item layui-form-text" style="margin-left: 160px;">
                            <div class="layui-input-block" style="border:1px solid ;color: #e2e2e2;height:220px;width: 400px;">
                                <div>
                                    <font size="3" color="black">【父事务】</font><br/>
                                    ----------------------------------------------------------------------
                                </div>
                                <a href="#"><font style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;哈哈哈哈哈</font></a>
                            </div>
                        </div>
                        <div class="layui-form-item layui-form-text" style="margin-left: 160px; margin-top: 20px;">
                            <div class="layui-input-block" style="border:1px solid ;color: #e2e2e2;height:220px;width: 400px;">
                                <div>
                                    <font size="3" color="black">【子事务】</font><br/>
                                    ----------------------------------------------------------------------
                                </div>
                                <a href="#"><font style="color: blue">&nbsp;&nbsp;&nbsp;&nbsp;哈哈哈哈哈</font></a>
                            </div>
                        </div>
                </div>
            </div>
        </div>
        <div class="layui-form-item" style="width: 80%;margin-left: 20px;">
            <div class="layui-input-block">
                <p>
                    <button class="layui-btn layui-btn-radius layui-btn-primary" lay-submit lay-filter="formDemo">保存</button>
                    <button type="button" class="layui-btn layui-btn-radius layui-btn-primary">转服务人员处理</button>
                    <button type="button" class="layui-btn layui-btn-radius layui-btn-primary" lay-submit lay-filter="serviceOver" formmethod="get">本次服务完成</button>
                    <button type="button" class="layui-btn layui-btn-radius layui-btn-primary" onclick="goback()">取消</button>
                </p>
            </div>
        </div>
    </center>

</form>
<script>
    layui.use(['form', 'layer', 'upload', 'laydate'], function () {
        var form = layui.form;
        var layer = layui.layer;
        var upload = layui.upload;
        var $=layui.jquery;

       $(function () {
           $.ajax({
               type:'get',
               url: '/customer/queryCustomer.do',
               datatype: 'json',
               success:function(data){
                   for (var i = 0; i < data.length; i++) {
                       $('#customerid').append(new Option(data[i].customername, data[i].customerid))
                   }
                   form.render();
               }
           });
       })

        form.on('select(customername)', function(data){
            $.ajax({
                type:'get',
                url: '/customer/queryCustomerById.do?customerid='+data.value,
                datatype: 'json',
                success:function(cus){
                    $("#contactperson").val(cus.linkman);
                    $("#officephone").val(cus.officephone);
                    $("#telephone").val(cus.telephone);
                    $("#email").val(cus.email);
                    $.ajax({
                        type:'get',
                        url: '/contract/queryContractByCustomer.do?customerid='+data.value,
                        datatype: 'json',
                        success:function(contract){
                            $("#contractid").empty();
                            form.render();
                            var str="<option value=''>请选择</option>";
                            for (var i = 0; i < contract.length; i++) {
                                 str+="<option value='"+contract[i].contractid+"'>"+contract[i].contractname+"</option>";
                            }
                            $("#contractid").html(str);
                            form.render();
                        }
                    });
                }
            });
        })

        form.on('select(contractid)', function(data){
            $.ajax({
                type:'get',
                url: '/aftersale/queryContractSaleByContractId.do?contractid='+data.value,
                datatype: 'json',
                success:function(aftersale){
                    $("#username").val(aftersale.username);
                    $("#userid").val(aftersale.userid);
                   var str="【合同全称】:"+aftersale.contractname+"  【合同所属部门】:"+aftersale.deptname+"  【关联人员】:"
                       +aftersale.associatedpersons+"  【签约日期】:  "+aftersale.signingdate+"  【生效日期】："+aftersale.takedate
                       +"  【合同状态】："+aftersale.todaystate+"  【服务期至】："+aftersale.serviceto;
                    $("#info").val(str);

                }
            });
        })

        //普通图片上传
        var uploadInst = upload.render({
            elem: '#card'
            ,url: '/aftersale/upload.do' //改成您自己的上传接口
            ,before: function(obj){
                //预读本地文件示例，不支持ie8
                obj.preview(function(index, file, result){
                    $('#idcard').attr('src', result); //图片链接（base64）
                });
            }
            ,done: function(res){
                //如果上传失败
                if(res.code == 0){
                    $("#attachment").val(res.data)
                    layer.msg('上传成功', {icon: 6});
                }else{
                    layer.msg('上传失败', {icon: 5});
                }
            }
        });

        form.on('submit(formDemo)', function(data){
            $.ajax({
                type: 'post',
                url: '/aftersale/addAfterSale.do', // ajax请求路径
                data: data.field,
                success: function(res){
                    if(res=='yes'){
                        layer.msg('添加成功');
                        location.href="aftersale.html"
                    }else if(data=='no'){
                        layer.msg('添加失败');
                    }
                }
            });
            return false;//禁止跳转，否则会提交两次，且页面会刷新
        });

        form.on('submit(serviceOver)', function(data){
            $.ajax({
                type: 'get',
                url: '/aftersale/addAfterSaleOver.do', // ajax请求路径
                data: data.field,
                success: function(res){
                    if(res=='yes'){
                        layer.msg('处理成功');
                        location.href="aftersale.html"
                    }else if(data=='no'){
                        layer.msg('处理失败');
                    }
                }
            });
            return false;//禁止跳转，否则会提交两次，且页面会刷新
        });

        form.verify({
            theme: function(value, item) { //value：表单的值、item：表单的DOM对象
                if(value.trim().length==0 ||null==value){
                    return '请填写主题';
                }
            }
            ,customername:function (value, item) {
                if(value.trim().length==0 || null==value){
                    return '请选择客户名称';
                }
            }
            ,typeservices:function (value, item) {
                if(value.trim().length==0 || null==value){
                    return '请选择服务类型';
                }
            }
            ,begintime:function (value, item) {
                if(value.trim().length==0 || null==value){
                    return '请选择服务开始时间';
                }
            }
            ,servicescontent:function (value, item) {
                if(value.trim().length==0 || null==value){
                    return '请输入服务内容';
                }
            }
            ,servicespeople:function (value, item) {
                if(value.trim().length==0 || null==value){
                    return '请输入服务人员';
                }
            }
            ,contract:function (value, item) {
                if(value.trim().length==0 || null==value){
                    return '请选择合同编号';
                }
            }
        });
    });
</script>
</body>
</html>